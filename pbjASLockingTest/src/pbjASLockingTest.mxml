<?xml version="1.0" encoding="utf-8"?>
<mx:Application xmlns:mx="http://www.adobe.com/2006/mxml" applicationComplete="initApp()">
  
  <mx:Script>
  <![CDATA[
    import pbjAS.ops.OpSub;
    import pbjAS.ops.OpAdd;
    import pbjAS.ops.OpDiv;
    import pbjAS.ops.OpRSqrt;
    import pbjAS.ops.OpSqrt;
    import flash.utils.ByteArray;
    
    import mx.controls.Alert;
 
    import pbjAS.ops.OpMov;
    import pbjAS.ops.OpMul;
    import pbjAS.regs.RFloat;
    import pbjAS.PBJType;
    import pbjAS.params.Parameter;
    import pbjAS.PBJ;
    import pbjAS.PBJAssembler;
    import pbjAS.PBJChannel;
    import pbjAS.params.Texture;
    import pbjAS.ops.OpSampleNearest;
  
    [Bindable] private var initDone:Boolean = false;
    
    private var shaderJob:ShaderJob
    
    private function initApp():void
    {
      var width:Number = 1000;
      var height:Number = 1000;
      
      var myPBJ:PBJ = new PBJ();
      myPBJ.version = 1;
      myPBJ.name = "TestOpSampleNearest";
      myPBJ.metadatas = [];
      myPBJ.parameters = [{name:"_OutCoord", p:new Parameter(PBJType.TFloat2, false, new RFloat(0, [PBJChannel.R, PBJChannel.G])), metas:[]}, // f0.rg
        {name:"texture", p:new Texture(2, 0), metas:[]}, // t0
        {name:"result", p:new Parameter(PBJType.TFloat2, true, new RFloat(1, [PBJChannel.R, PBJChannel.G])), metas:[]} // f1.rg
        ];
      myPBJ.code = [
        new OpSampleNearest(new RFloat(1, [PBJChannel.R, PBJChannel.G]), new RFloat(0, [PBJChannel.R, PBJChannel.G]), 0) // texn    f1.rg, f0.rg, t0
        ];
        
      for (var k:int = 0; k < 1000; k++)
      {
        myPBJ.code.push(new OpSqrt(new RFloat(1, [PBJChannel.R, PBJChannel.G]), new RFloat(1, [PBJChannel.R, PBJChannel.G]))); // sqrt f1.rg, f1.rg
        myPBJ.code.push(new OpRSqrt(new RFloat(1, [PBJChannel.R, PBJChannel.G]), new RFloat(1, [PBJChannel.R, PBJChannel.G]))); // rsqrt f1.rg, f1.rg
        myPBJ.code.push(new OpMul(new RFloat(1, [PBJChannel.R, PBJChannel.G]), new RFloat(1, [PBJChannel.R, PBJChannel.G]))); // mul f1.rg, f1.rg
        myPBJ.code.push(new OpDiv(new RFloat(1, [PBJChannel.R, PBJChannel.G]), new RFloat(1, [PBJChannel.R, PBJChannel.G]))); // div f1.rg, f1.rg
        myPBJ.code.push(new OpAdd(new RFloat(1, [PBJChannel.R, PBJChannel.G]), new RFloat(1, [PBJChannel.R, PBJChannel.G]))); // add f1.rg, f1.rg
        myPBJ.code.push(new OpSub(new RFloat(1, [PBJChannel.R, PBJChannel.G]), new RFloat(1, [PBJChannel.R, PBJChannel.G]))); // sub f1.rg, f1.rg
      }

      var assembledPBJByteArray:ByteArray = PBJAssembler.assemble(myPBJ);

      var texture:Vector.<Number> = new Vector.<Number>();

      for (var i:int = 1; i <= height; i++)
      {
        for (var j:int = 1; j <= width; j++)
        {
          texture.push(j * i);
          texture.push(j / i);
        }
      }

      var testShader:Shader = new Shader(assembledPBJByteArray);

      testShader.data.texture.width = width;
      testShader.data.texture.height = height;
      testShader.data.texture.input = texture;

      var result:Vector.<Number> = new Vector.<Number>;

      shaderJob = new ShaderJob(testShader, result, width, height);
      shaderJob.addEventListener(Event.COMPLETE, onFloatShaderJobComplete);
      
      initDone = true;
    }
    
    private function startJob():void
    {
      var timer:Timer = new Timer(100);
      timer.addEventListener(TimerEvent.TIMER, tick);
      timer.start();
      
      shaderJob.start();
    }
    
    private function tick(event:TimerEvent):void
    {
      ta.text = (shaderJob.progress * 100) + "% complete";
    }
    
    private function onFloatShaderJobComplete(event:ShaderEvent):void
    {
      ta.text = "done! \n";
    }
      
  ]]>
  </mx:Script>
  
  <mx:Button label="start" click="startJob()" enabled="{initDone}"/>
  
  <mx:TextArea id="ta" width="100%" height="100%"/>
  
</mx:Application>